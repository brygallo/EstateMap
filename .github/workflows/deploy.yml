name: Deploy to Contabo Server

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:  # Permite ejecuciÃ³n manual

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DOMAIN: ${{ secrets.DOMAIN }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
        run: |
          ssh $SERVER_USER@$SERVER_IP << 'ENDSSH'
            set -e

            # Colores para output
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            NC='\033[0m'

            echo -e "${GREEN}ðŸš€ Starting deployment...${NC}"

            # Navegar al directorio del proyecto
            cd /var/www/estatemap || exit 1

            # Backup antes de actualizar
            echo -e "${YELLOW}ðŸ“¦ Creating backup...${NC}"
            sudo docker-compose exec -T db pg_dump -U postgres estatemap > backup_$(date +%Y%m%d_%H%M%S).sql || true

            # Pull latest changes
            echo -e "${YELLOW}ðŸ“¥ Pulling latest code...${NC}"
            git fetch origin
            git reset --hard origin/main

            # Actualizar variables de entorno
            echo -e "${YELLOW}ðŸ”§ Updating environment variables...${NC}"
            cat > .env.production << EOF
          DJANGO_SECRET_KEY=$DJANGO_SECRET_KEY
          DB_PASSWORD=$DB_PASSWORD
          MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
          DOMAIN=$DOMAIN
          DJANGO_ALLOWED_HOSTS=$DOMAIN,www.$DOMAIN
          CORS_ALLOWED_ORIGINS=https://$DOMAIN,https://www.$DOMAIN
          EOF

            # Build y deploy
            echo -e "${YELLOW}ðŸ—ï¸  Building images...${NC}"
            sudo docker-compose -f docker-compose.prod.yml build --no-cache

            echo -e "${YELLOW}â¬†ï¸  Updating services...${NC}"
            sudo docker-compose -f docker-compose.prod.yml up -d

            # Ejecutar migraciones
            echo -e "${YELLOW}ðŸ—„ï¸  Running migrations...${NC}"
            sudo docker-compose -f docker-compose.prod.yml exec -T backend python manage.py migrate --noinput

            # Collect static files
            echo -e "${YELLOW}ðŸ“¦ Collecting static files...${NC}"
            sudo docker-compose -f docker-compose.prod.yml exec -T backend python manage.py collectstatic --noinput

            # Limpiar imÃ¡genes antiguas
            echo -e "${YELLOW}ðŸ§¹ Cleaning up...${NC}"
            sudo docker image prune -af || true

            # Verificar estado
            echo -e "${GREEN}âœ… Deployment completed!${NC}"
            echo -e "${GREEN}ðŸ“Š Container status:${NC}"
            sudo docker-compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: Verify deployment
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          echo "Waiting for services to be ready..."
          sleep 10

          # Check if site is accessible
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN || echo "000")

          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "âœ… Site is accessible (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Site returned HTTP $HTTP_STATUS"
            exit 1
          fi

      - name: Notify success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Site: https://${{ secrets.DOMAIN }}"

      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs above for details."
